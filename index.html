<!DOCTYPE html>
<html lang="en">
 
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
	  <script src="https://cdn.jsdelivr.net/gh/xaoxuu/volantis@1/js/volantis.min.js"></script>
	  <script src="https://old.cz5h.com/js/valine-min.js" charset="utf-8" type="text/javascript"></script>
	  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js"></script>
 
    <title>Hello!</title>
<style>
  /* bubble style */
 
        .sender{
            clear:both;
        }
        .sender div:nth-of-type(1){
            float: left;
        }
        .sender div:nth-of-type(2){
            background-color: #b3e1ff;
            float: left;
            margin: 0 20px 10px 15px;
            padding: 9px 10px 10px 10px;
            border-radius:7px;
            max-width:500px;
            position: relative;
            word-wrap:break-word;word-break:break-all;white-space: normal;
          z-index:999;
        }

  
        .receiver div:first-child img,
        .sender div:first-child img{
            width:40px;
            height: 40px;
            border-radius:25px;
        }
 
        .receiver{
            clear:both;
        }
        .receiver div:nth-child(1){
            float: right;
        }
        .receiver div:nth-of-type(2){
            float:right;
            background-color: #b3e1ff;
            margin: 0px 15px 10px 20px;
            padding: 10px 10px 10px 12px;
            border-radius:7px;
            max-width:500px;
            word-wrap:break-word;word-break:break-all;white-space: normal;
        }
 
        .rname{
            float:right;
            font-size: 8px !important;
            color: #969696;
            margin-right:15px;
        }
        .lname{
            float:left;
            font-size: 8px !important;
            color: #969696;
            margin-left:15px;
        }
 
        .right_txt{

        }
  
        .left_triangle{
            height:0px;  
            width:0px;  
            border-width:6px;  
            border-style:solid;  
            border-color:#b3e1ff #b3e1ff transparent  transparent;
            position: absolute;
            left:-11px;
            
          z-index:-1;
        }
 
        .right_triangle{
            height:0px;  
            width:0px;  
            border-width:6px;  
            border-style:solid;  
            border-color: #b3e1ff transparent  transparent  #b3e1ff; 
            position: relative;
            right:-21px;

        }

        .timm{
          color: #969696;font-size: 8px;
          margin-top: 20px;margin-bottom: 15px;
          text-align: center;

        }
 

        a { text-decoration:none;}
        body {margin:0}
  
        @media screen and (max-width: 680px) {
            .sender div:nth-of-type(2){
                max-width:300px;
            }
            .receiver div:nth-of-type(2){
                max-width:300px;
            }
        }
        @media screen and (max-width: 500px) {
            .sender div:nth-of-type(2){
                max-width:180px;
            }
            .receiver div:nth-of-type(2){
                max-width:180px;
            }
        }
        .main{
          background-color:#f0f3f6;
          padding-left:20px;
          padding-right:20px;
        }
        @media screen and (min-width: 1000px) {
          .main{
            max-width:1000px;
            display: block;
            margin:0 auto;
          }
        }
  </style>

  
  <!-- Right -->
  
  
 
	<div id="allinshow" class="main"></div>
  <div class="comments vcomment" id="comments"></div>
    
	<script>
 
	AV.init({
		//appId:"PW4p5yuQfOGT9EITp5LE5aAq-MdYXbMMI",appKey:"jvG1mwtdlCeGgyL1s4z4NIir" //nmsl
		//appId: "E7rWTTEsGSblT8OB06beui59-MdYXbMMI", appKey: "y4jlkd52FFbLb0kLALU0mrMm", //x4wj
		appId:'WbLE88qfAcz4hSI5GsQFRlzW-gzGzoHsz',  appKey:'ycqjmtEfUxuxD3IY97oRkrdO'
		//appid: '6BMsyigADmQmTmVot7Bvfedv-MdYXbMMI', appkey: 't9Qx24vbwvimWMK2wzceFrQX',
		//appId: 'ikEEo5XOYTytaqIUMsLaiisX-gzGzoHsz', appKey: 'CBx5lgfUldUe1i1qBC6m7k0K',
	});
	//console.log(window.AV);
	var query = new AV.Query("Comment");
	query.descending("createdAt");//升序
	query.find().then(function(data){
	  //查询的结果数据 data
	  //将data转成json格式
	 var jsondata = JSON.parse(JSON.stringify(data));
 
	function formatDate(time){
		var date = new Date(time);

		var year = date.getFullYear(),
			month = date.getMonth() + 1,//月份是从0开始的
			day = date.getDate(),
			hour = date.getHours(),
			min = date.getMinutes(),
			sec = date.getSeconds();
 
		return {
      "day":month+'-'+day+'-'+year,
      "time":hour+':'+min+':'+sec
    };         
	}
    


    
  function getPic(str){  
    var result;
    pt = /^\d+@qq\.com$/;
    if (pt.test(str)) {
        var prefix = str.replace(/@.*/, ""),
            pattern = /^\d+$/g,
            result = prefix.match(pattern);
        result = "//q.qlogo.cn/headimg_dl?dst_uin=" + prefix + "&spec=640";
    }else if (str.indexOf("@") >= 0) {
        result = "http://www.gravatar.com/avatar/"+md5(data[p].attributes.mail)+"?s=32";
    }else{
        result = "http://www.gravatar.com/avatar/"+md5(data[p].attributes.mail)+"?s=32&&d=identicon";
    }
    return result;
  }  
  var pre = "time.day"; 
    
  $('#allinshow').append('<br><center><a class="timm" >更多历史评论请前往cz5h.com查阅！</a></center><br><br>');
    
	for(var p = data.length-1; p>=0;p--){//遍历json数组时，这么写p为索引，0,1
  //for(var p in data){//遍历json数组时，这么写p为索引，0,1
    var time = formatDate(data[p].attributes.insertedAt); 
    
    var t;
    
    if (pre != time.day){
      console.log(pre,time.day);
      t = '<div class="timm">'+time.day+'</div>';
      pre = time.day;
    }else{
      t = '';
    }
		if(data[p].attributes.nick!="Administrator"
       &&data[p].attributes.nick!="胖五鸭"
       &&data[p].attributes.nick!="胖五"){
			//console.log(data[p].attributes.url);
			$('#allinshow').append(
        t
        +'<div class="sender">'
            +'<div><img src='+getPic(data[p].attributes.mail)+'></div>'
            +'<span class="lname">'+data[p].attributes.nick+'</span><br>'
            +'<div><div class="left_triangle"></div>'+data[p].attributes.comment.replace("<p>","").replace("</p>","")+'</div>'
        +'</div><div style="clear: both;"></div>'
        
        );

		}else{
      $('#allinshow').append(
        t
        +'<div class="receiver">'
            +'<div><img src="http://q.qlogo.cn/headimg_dl?dst_uin=1805984583&spec=640"></div>'
            +'<span class="rname">'+data[p].attributes.nick+'</span><br>'
            +'<div><div class="right_triangle"></div>'+data[p].attributes.comment.replace("<p>","").replace("</p>","")+'</div>'
        +'</div><div style="clear: both;"></div>' 
        
        );
 
    }
	}
  $('#allinshow').append('<br><center><a name="end" id="end"class="timm" >已到达最新评论！</a></center><br><br>');
	},function(err) {
	  //错误信息 err
	  //console.log('err');
	});
 
  $("html,body").animate({scrollTop: $("#end").offset().top}, 3000);
    
	</script>
  
 
 
</html>
